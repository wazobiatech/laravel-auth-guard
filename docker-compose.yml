version: '3.8'

services:
  # Main development container
  laravel-auth-guard-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: laravel-auth-guard-dev
    volumes:
      - .:/app
      - ./logs:/app/logs
      - composer-cache:/root/.composer
    environment:
      - MERCURY_BASE_URL=${MERCURY_BASE_URL:-https://mercury.tiadara.com}
      - SIGNATURE_SHARED_SECRET=${SIGNATURE_SHARED_SECRET:-AAAAB3NzaC1yc2EAAAADAQABAAACAQD3GObqRywP1xuNkk9SltJ}
      - SERVICE_ID=${SERVICE_ID:-4d3ab1f6-cd27-457f-b727-bcbb37f6b58f}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS512}
      - AUTH_CACHE_TTL=${AUTH_CACHE_TTL:-3600}
      - AUTH_LOGGING_ENABLED=${AUTH_LOGGING_ENABLED:-true}
      - AUTH_JWT_HEADER=${AUTH_JWT_HEADER:-Authorization}
      - AUTH_PROJECT_TOKEN_HEADER=${AUTH_PROJECT_TOKEN_HEADER:-X-Project-Token}
      - REDIS_HOST=redis-dev
      - REDIS_PORT=6379
      - REDIS_AUTH_DB=${REDIS_AUTH_DB:-0}
      - XDEBUG_MODE=debug
      - PHP_IDE_CONFIG=serverName=laravel-auth-guard
    ports:
      - "9003:9003"  # Xdebug port
    networks:
      - auth-guard-dev
    depends_on:
      - redis-dev
    stdin_open: true
    tty: true

  # Redis for caching and testing
  redis-dev:
    image: redis:7-alpine
    container_name: laravel-auth-guard-redis-dev
    ports:
      - "6381:6379"  # Different port to avoid conflicts
    volumes:
      - redis-data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - auth-guard-dev
    restart: unless-stopped

  # Redis Commander for GUI management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: laravel-auth-guard-redis-commander
    hostname: redis-commander
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=local:redis-dev:6379
    networks:
      - auth-guard-dev
    depends_on:
      - redis-dev
    restart: unless-stopped

  # PHPUnit test runner (separate container for isolation)
  phpunit:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: laravel-auth-guard-phpunit
    volumes:
      - .:/app
      - ./logs:/app/logs
    environment:
      - MERCURY_BASE_URL=${MERCURY_BASE_URL:-https://mercury.tiadara.com}
      - SIGNATURE_SHARED_SECRET=${SIGNATURE_SHARED_SECRET:-AAAAB3NzaC1yc2EAAAADAQABAAACAQD3GObqRywP1xuNkk9SltJ}
      - SERVICE_ID=${SERVICE_ID:-4d3ab1f6-cd27-457f-b727-bcbb37f6b58f}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS512}
      - REDIS_HOST=redis-dev
      - REDIS_PORT=6379
      - REDIS_AUTH_DB=${REDIS_AUTH_DB:-1}  # Different DB for tests
    networks:
      - auth-guard-dev
    depends_on:
      - redis-dev
    profiles:
      - testing
    command: ./vendor/bin/phpunit

  # Nginx for serving documentation or examples (optional)
  nginx:
    image: nginx:alpine
    container_name: laravel-auth-guard-nginx
    ports:
      - "8080:80"
    volumes:
      - ./docs:/usr/share/nginx/html:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - auth-guard-dev
    profiles:
      - docs
    restart: unless-stopped

volumes:
  redis-data:
    driver: local
  composer-cache:
    driver: local

networks:
  auth-guard-dev:
    driver: bridge